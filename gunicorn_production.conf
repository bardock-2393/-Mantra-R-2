# Gunicorn Production Configuration for 2GB+ Video Uploads
# Optimized for 80GB GPU Environment

# Server socket
bind = "127.0.0.1:8000"
backlog = 2048

# Worker processes
workers = 2                    # Fewer workers to conserve GPU memory
worker_class = "gthread"       # Thread-based workers for I/O efficiency
threads = 8                    # More threads for concurrent uploads
worker_connections = 1000

# Timeouts - Critical for large uploads
timeout = 3600                 # 1 hour worker timeout for large uploads
keepalive = 120               # Keep connections alive for efficiency
graceful_timeout = 30

# Memory and resource limits
max_requests = 100            # Restart workers periodically to prevent memory leaks
max_requests_jitter = 20      # Add randomness to restarts
worker_tmp_dir = "/dev/shm"   # Use shared memory for temporary files

# Process naming
proc_name = "ai_video_detective"

# Security
limit_request_line = 8192
limit_request_fields = 100
limit_request_field_size = 16384

# Logging
loglevel = "info"
access_log = "/var/log/gunicorn/ai_video_detective_access.log"
error_log = "/var/log/gunicorn/ai_video_detective_error.log"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# SSL (if terminating SSL at Gunicorn instead of nginx)
# keyfile = "/path/to/your/privkey.pem"
# certfile = "/path/to/your/fullchain.pem"

# Performance tuning
preload_app = True            # Preload app to save memory and startup time
enable_stdio_inheritance = True

# Restart workers gracefully
reload = False
reload_engine = "auto"

# Monitoring
statsd_host = None            # Configure if using StatsD monitoring

# Additional environment variables
raw_env = [
    "FLASK_ENV=production",
    "UPLOAD_FOLDER=/var/uploads/ai_video_detective",
    "REDIS_URL=redis://your-redis-url",
]